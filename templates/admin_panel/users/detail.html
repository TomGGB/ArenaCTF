{% extends "admin_panel/base.html" %}

{% block title %}{{ user.username }} - Panel Admin{% endblock %}

{% block admin_content %}
<div class="flex items-center justify-between mb-6">
    <div>
        <h1 class="text-3xl font-bold text-primary">{{ user.username }}</h1>
        <p class="text-base-content/70 mt-1">Perfil completo del usuario</p>
    </div>
    <div class="flex gap-2">
        <a href="{% url 'admin_panel:users_list' %}" class="btn btn-outline btn-sm">
            ‚Üê Volver
        </a>
        <a href="{% url 'admin_panel:user_edit' user.id %}" class="btn btn-warning btn-sm">
            ‚úèÔ∏è Editar
        </a>
        <a href="{% url 'admin_panel:user_ban' user.id %}" 
           class="btn btn-sm {% if user.is_active %}btn-error{% else %}btn-success{% endif %}">
            {% if user.is_active %}üö´ Banear{% else %}‚úÖ Desbanear{% endif %}
        </a>
        <a href="{% url 'admin_panel:user_delete' user.id %}" class="btn btn-error btn-sm">
            üóëÔ∏è Eliminar
        </a>
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <div class="lg:col-span-1 space-y-6">
        <div class="card bg-base-200 shadow-xl">
            <div class="card-body items-center text-center">
                <div class="avatar placeholder mb-4">
                    <div class="bg-primary text-primary-content rounded-full w-24">
                        <span class="text-4xl">{{ user.username|first|upper }}</span>
                    </div>
                </div>
                <h2 class="card-title text-2xl">{{ user.username }}</h2>
                <p class="text-base-content/70">{{ user.email }}</p>
                
                <div class="flex gap-2 mt-4">
                    {% if user.is_superuser %}
                    <span class="badge badge-error badge-lg">üîë Superadmin</span>
                    {% elif user.is_staff %}
                    <span class="badge badge-warning badge-lg">‚ö° Staff</span>
                    {% else %}
                    <span class="badge badge-ghost badge-lg">üë§ Usuario</span>
                    {% endif %}
                    
                    {% if user.is_active %}
                    <span class="badge badge-success badge-lg">‚úì Activo</span>
                    {% else %}
                    <span class="badge badge-error badge-lg">‚úó Inactivo</span>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="card bg-base-300 shadow-xl">
            <div class="card-body">
                <h3 class="card-title text-lg">‚ÑπÔ∏è Informaci√≥n</h3>
                <div class="space-y-3 mt-4">
                    <div>
                        <p class="text-xs text-base-content/70">Fecha de Registro</p>
                        <p class="font-semibold">{{ user.date_joined|date:"d/m/Y H:i" }}</p>
                        <p class="text-xs text-base-content/50">Hace {{ user.date_joined|timesince }}</p>
                    </div>
                    <div class="divider my-2"></div>
                    <div>
                        <p class="text-xs text-base-content/70">√öltimo Login</p>
                        {% if user.last_login %}
                        <p class="font-semibold">{{ user.last_login|date:"d/m/Y H:i" }}</p>
                        <p class="text-xs text-base-content/50">Hace {{ user.last_login|timesince }}</p>
                        {% else %}
                        <p class="text-base-content/50 italic">Nunca</p>
                        {% endif %}
                    </div>
                    <div class="divider my-2"></div>
                    <div>
                        <p class="text-xs text-base-content/70">ID de Usuario</p>
                        <p class="font-mono text-xs break-all">{{ user.id }}</p>
                    </div>
                </div>
            </div>
        </div>

        {% if user.teams.exists %}
        {% with user_team=user.teams.first %}
        <div class="card bg-primary/10 border-2 border-primary shadow-xl">
            <div class="card-body">
                <h3 class="card-title text-lg">üë• Equipo</h3>
                <div class="mt-4">
                    <a href="{% url 'admin_panel:team_detail' user_team.id %}" 
                       class="btn btn-primary btn-block">
                        {{ user_team.name }}
                    </a>
                    <div class="stats stats-vertical shadow bg-base-200 mt-4 w-full">
                        <div class="stat py-3">
                            <div class="stat-title text-xs">Puntaje del Equipo</div>
                            <div class="stat-value text-2xl text-success">{{ user_team.score }}</div>
                        </div>
                        <div class="stat py-3">
                            <div class="stat-title text-xs">Miembros</div>
                            <div class="stat-value text-2xl text-info">{{ user_team.members.count }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endwith %}
        {% else %}
        <div class="card bg-warning/10 border-2 border-warning shadow-xl">
            <div class="card-body">
                <h3 class="card-title text-lg text-warning">‚ö†Ô∏è Sin Equipo</h3>
                <p class="text-sm text-base-content/70 mt-2">
                    Este usuario no pertenece a ning√∫n equipo actualmente.
                </p>
            </div>
        </div>
        {% endif %}
    </div>

    <div class="lg:col-span-2 space-y-6">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="card bg-gradient-to-br from-success to-success/80 text-success-content shadow-xl">
                <div class="card-body py-4">
                    <h3 class="text-xs opacity-90">Puntos Totales</h3>
                    <p class="text-4xl font-bold">{{ total_points }}</p>
                </div>
            </div>

            <div class="card bg-gradient-to-br from-info to-info/80 text-info-content shadow-xl">
                <div class="card-body py-4">
                    <h3 class="text-xs opacity-90">Solves</h3>
                    <p class="text-4xl font-bold">{{ solved_count }}</p>
                </div>
            </div>

            <div class="card bg-gradient-to-br from-error to-error/80 text-error-content shadow-xl">
                <div class="card-body py-4">
                    <h3 class="text-xs opacity-90">First Bloods</h3>
                    <p class="text-4xl font-bold">{{ first_bloods_count }}</p>
                </div>
            </div>

            <div class="card bg-gradient-to-br from-warning to-warning/80 text-warning-content shadow-xl">
                <div class="card-body py-4">
                    <h3 class="text-xs opacity-90">Intentos</h3>
                    <p class="text-4xl font-bold">{{ total_submissions }}</p>
                </div>
            </div>
        </div>

        <div class="card bg-base-200 shadow-xl">
            <div class="card-body">
                <h2 class="card-title">üéØ Challenges Resueltos</h2>
                {% if solved_challenges %}
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-4">
                    {% for submission in solved_challenges %}
                    <div class="card bg-base-300 shadow">
                        <div class="card-body p-4">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <h3 class="font-bold text-sm">{{ submission.challenge.title }}</h3>
                                    <div class="flex items-center gap-2 mt-1">
                                        <span class="badge badge-primary badge-sm">
                                            {{ submission.challenge.category.name }}
                                        </span>
                                        <span class="text-xs text-success font-semibold">
                                            {{ submission.challenge.points }} pts
                                        </span>
                                    </div>
                                    <p class="text-xs text-base-content/50 mt-1">
                                        {{ submission.submitted_at|date:"d/m/Y H:i" }}
                                    </p>
                                </div>
                                {% if submission.challenge.id in first_blood_challenges %}
                                <span class="badge badge-error">ü©∏ FB</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-8 text-base-content/50">
                    <p>No ha resuelto ning√∫n challenge a√∫n</p>
                </div>
                {% endif %}
            </div>
        </div>

        {% if first_bloods %}
        <div class="card bg-error/10 border-2 border-error shadow-xl">
            <div class="card-body">
                <h2 class="card-title text-error">ü©∏ First Bloods</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-4">
                    {% for fb in first_bloods %}
                    <div class="card bg-base-200 shadow">
                        <div class="card-body p-4">
                            <h3 class="font-bold text-sm">{{ fb.challenge.title }}</h3>
                            <div class="flex items-center justify-between mt-2">
                                <span class="badge badge-primary badge-sm">
                                    {{ fb.challenge.category.name }}
                                </span>
                                <span class="badge badge-error">
                                    +{{ fb.challenge.points }} pts
                                </span>
                            </div>
                            <p class="text-xs text-base-content/50 mt-1">
                                {{ fb.achieved_at|date:"d/m/Y H:i" }}
                            </p>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}

        <div class="card bg-base-200 shadow-xl">
            <div class="card-body">
                <h2 class="card-title">üìú Historial de Submissions</h2>
                {% if recent_submissions %}
                <div class="overflow-x-auto mt-4">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Challenge</th>
                                <th>Categor√≠a</th>
                                <th>Estado</th>
                                <th>Fecha</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for submission in recent_submissions %}
                            <tr>
                                <td class="font-semibold">{{ submission.challenge.title }}</td>
                                <td>
                                    <span class="badge badge-primary badge-sm">
                                        {{ submission.challenge.category.name }}
                                    </span>
                                </td>
                                <td>
                                    {% if submission.is_correct %}
                                    <span class="badge badge-success badge-sm">‚úì Correcto</span>
                                    {% else %}
                                    <span class="badge badge-error badge-sm">‚úó Incorrecto</span>
                                    {% endif %}
                                </td>
                                <td class="text-xs text-base-content/70">
                                    {{ submission.submitted_at|date:"d/m/Y H:i" }}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% if total_submissions > 20 %}
                <p class="text-xs text-base-content/50 text-center mt-2">
                    Mostrando las √∫ltimas 20 submissions de {{ total_submissions }} totales
                </p>
                {% endif %}
                {% else %}
                <div class="text-center py-8 text-base-content/50">
                    <p>No hay submissions registradas</p>
                </div>
                {% endif %}
            </div>
        </div>

        <div class="card bg-base-200 shadow-xl">
            <div class="card-body">
                <h2 class="card-title">üìä Progreso por Categor√≠a</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                    {% for cat_name, cat_data in categories_progress.items %}
                    <div class="card bg-base-300 shadow">
                        <div class="card-body p-4">
                            <h3 class="font-semibold">{{ cat_name }}</h3>
                            <div class="flex justify-between items-center mt-2">
                                <span class="text-sm">{{ cat_data.solved }}/{{ cat_data.total }}</span>
                                <span class="text-sm font-semibold text-success">
                                    {{ cat_data.points }} pts
                                </span>
                            </div>
                            <progress class="progress progress-primary mt-2" 
                                      value="{{ cat_data.solved }}" 
                                      max="{{ cat_data.total }}"></progress>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}


