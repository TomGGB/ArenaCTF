{% extends 'base.html' %}

{% block title %}Challenges - {{ ctf_name }}{% endblock %}

{% block extra_css %}
<style>
    @keyframes checkmark {
        0% { transform: scale(0) rotate(-45deg); }
        50% { transform: scale(1.2) rotate(10deg); }
        100% { transform: scale(1) rotate(0); }
    }
    .solved-check {
        animation: checkmark 0.5s ease-out;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Header -->
    <div class="text-center mb-8">
        <h1 class="text-4xl font-gaming font-bold text-success mb-2">
            Challenges
        </h1>
        <p class="text-sm opacity-60">Resuelve los desaf√≠os y gana puntos</p>
    </div>

    <!-- CTF Ended Alert -->
    {% if ctf_ended %}
    <div class="alert alert-error shadow-lg mb-6">
        <div class="flex items-center gap-3">
            <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-8 w-8" fill="none" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <div>
                <h3 class="font-gaming text-xl font-bold">üèÅ El CTF ha finalizado</h3>
                <div class="text-sm">Ya no se aceptan nuevas submissions. Los challenges est√°n en modo solo lectura.</div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Categories -->
    <div class="space-y-8">
        {% for category in categories %}
        <div class="card bg-base-300 border border-base-content/10 hover:border-success/50 transition-all" style="border-color: {{ category.color }}">
            <div class="card-body">
                <!-- Category Header -->
                <div class="flex items-center gap-3 mb-4">
                    <span class="text-3xl">{{ category.icon }}</span>
                    <div>
                        <h2 class="text-2xl font-gaming font-semibold" style="color: {{ category.color }}">{{ category.name }}</h2>
                        <p class="text-xs opacity-60">({{ category.challenges.count }} challenges)</p>
                    </div>
                </div>
                
                <!-- Challenges Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3">
                    {% for challenge in category.challenges.all %}
                    {% if challenge.is_active %}
                    <div class="card cursor-pointer transition-all {% if challenge.id in solved_challenges %}bg-success/10 border-2 border-success opacity-75{% else %}bg-base-200 border border-base-content/10 hover:border-success{% endif %}" 
                         style="{% if challenge.id not in solved_challenges %}border-color: {{ category.color }}{% endif %}"
                         onclick="openChallengeModal('{{ challenge.id }}');">
                        <div class="card-body p-3 relative">
                            {% if challenge.id in solved_challenges %}
                            <div class="absolute top-2 right-2">
                                <div class="badge badge-success gap-1">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                                    </svg>
                                    Resuelto
                                </div>
                            </div>
                            {% endif %}
                            
                            <h3 class="font-gaming font-semibold text-base mb-2 {% if challenge.id in solved_challenges %}opacity-70{% endif %}">
                                {{ challenge.title }}
                            </h3>
                            
                            <div class="flex items-center justify-between mt-auto">
                                <div class="badge {% if challenge.id in solved_challenges %}badge-success badge-outline{% else %}badge-success{% endif %} badge-sm font-mono">
                                    {{ challenge.points }} pts
                                </div>
                                <div class="text-xs opacity-60 flex items-center gap-1">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor">
                                        <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z" />
                                    </svg>
                                    <span>{{ challenge.get_solve_count }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Challenge Modal -->
<dialog id="challengeModal" class="modal">
    <div class="modal-box w-11/12 max-w-2xl bg-base-300 border-2 border-success">
        <form method="dialog">
            <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2 text-xl hover:text-error">‚úï</button>
        </form>
        <div id="modalContent" class="py-4"></div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>
{% endblock %}

{% block extra_js %}
<script>
    function openChallengeModal(challengeId) {
        fetch(`/challenges/${challengeId}/`)
            .then(response => response.text())
            .then(html => {
                document.getElementById('modalContent').innerHTML = html;
                document.getElementById('challengeModal').showModal();
            })
            .catch(error => {
                console.error('Error loading challenge:', error);
                alert('Error al cargar el desaf√≠o');
            });
    }
    
    function submitFlag(event, challengeId) {
        if (event) event.preventDefault();
        
        {% if ctf_ended %}
        // CTF ha finalizado, no permitir submissions
        const resultDiv = document.getElementById('flagResult');
        if (resultDiv) {
            resultDiv.innerHTML = `
                <div class="alert alert-error">
                    <span class="font-gaming">‚è∞ El CTF ha finalizado. Ya no se aceptan submissions.</span>
                </div>
            `;
        }
        return;
        {% endif %}
        
        const form = document.getElementById(`flagForm-${challengeId}`);
        const flagInput = document.getElementById(`flagInput-${challengeId}`);
        const resultDiv = document.getElementById('flagResult');
        
        if (!form || !flagInput || !resultDiv) {
            console.error('Elements not found:', {form, flagInput, resultDiv});
            alert('Error: elementos del formulario no encontrados');
            return;
        }
        
        const flagValue = flagInput.value.trim();
        if (!flagValue) {
            resultDiv.innerHTML = `
                <div class="alert alert-warning">
                    <span class="font-gaming">Por favor ingresa una flag</span>
                </div>
            `;
            return;
        }
        
        const formData = new FormData(form);
        const csrfToken = formData.get('csrfmiddlewaretoken');
        
        console.log('Submitting flag:', {challengeId, flagValue, csrfToken});
        
        // Mostrar loading
        resultDiv.innerHTML = `
            <div class="alert alert-info">
                <span class="loading loading-spinner loading-sm"></span>
                <span class="font-gaming">Verificando flag...</span>
            </div>
        `;
        
        fetch(`/challenges/${challengeId}/submit/`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => {
            console.log('Response status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Response data:', data);
            
            if (data.success) {
                resultDiv.innerHTML = `
                    <div class="alert alert-success">
                        <div>
                            <span class="font-gaming text-lg">${data.message}</span>
                            ${data.is_first_blood ? '<p class="text-error text-sm font-bold mt-2">ü©∏ FIRST BLOOD! +50 pts bonus</p>' : ''}
                            <p class="text-sm mt-1">+${data.points} puntos para tu equipo</p>
                        </div>
                    </div>
                `;
                setTimeout(() => location.reload(), 2500);
            } else {
                resultDiv.innerHTML = `
                    <div class="alert alert-error">
                        <span class="font-gaming">${data.message || data.error}</span>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Fetch error:', error);
            resultDiv.innerHTML = `
                <div class="alert alert-error">
                    <span class="font-gaming">Error al enviar la flag: ${error.message}</span>
                </div>
            `;
        });
    }
</script>
{% endblock %}
