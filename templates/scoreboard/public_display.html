{% load static %}
<!DOCTYPE html>
<html lang="es" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ARENA CTF - Live Display</title>
    
    <!-- Tailwind CSS + DaisyUI -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.4.19/dist/full.min.css" rel="stylesheet" type="text/css" />
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'gaming': ['Rajdhani', 'sans-serif'],
                        'mono': ['Space Mono', 'monospace'],
                    }
                }
            }
        }
    </script>

    <style>
        body {
            font-family: 'Rajdhani', sans-serif;
        }
        
        /* Animaciones de notificaciones */
        @keyframes notificationShow {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
            10% { transform: translate(-50%, -50%) scale(1.05); opacity: 1; }
            90% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(0.95); opacity: 0; }
        }
        
        .notification-overlay {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 9999;
            animation: notificationShow 4s ease-in-out;
            max-width: 70vw;
        }
        
        .notification-icon {
            font-size: 4rem;
            animation: iconBounce 0.5s ease-in-out;
        }
        
        @keyframes iconBounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.15); }
        }
        
        /* Efectos de ranking */
        .team-row {
            transition: all 0.3s ease;
        }
        
        .team-row.updated {
            animation: rowFlash 1s ease-in-out;
        }
        
        @keyframes rowFlash {
            0%, 100% { background-color: transparent; }
            50% { background-color: rgba(74, 222, 128, 0.1); }
        }

        /* Status indicator pulse */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .status-pulse {
            animation: pulse 2s ease-in-out infinite;
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- Audio activation overlay -->
    <div id="audioEnableOverlay" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[10000] flex items-center justify-center" style="display: none;">
        <div class="card bg-base-300 shadow-2xl max-w-md">
            <div class="card-body text-center">
                <h2 class="text-3xl font-gaming font-bold mb-4">üîä Activar Audio</h2>
                <p class="mb-6 opacity-80">Haz clic para habilitar las notificaciones de audio en tiempo real</p>
                <button onclick="enableAudio()" class="btn btn-primary btn-lg gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
                    </svg>
                    Activar Audio
                </button>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="flex items-center justify-between mb-8">
            <div>
                <h1 class="text-5xl font-gaming font-bold bg-gradient-to-r from-success to-info bg-clip-text text-transparent mb-2">
                    ARENA SCOREBOARD
                </h1>
                <p class="text-sm opacity-60">
                    <span class="badge badge-success gap-2">
                        <span class="status-pulse inline-block w-2 h-2 bg-success-content rounded-full"></span>
                        EN VIVO
                    </span>
                    <span class="ml-2">√öltima actualizaci√≥n: <span id="currentTime"></span></span>
                </p>
            </div>
            <button onclick="toggleAudio()" id="audioToggle" class="btn btn-primary gap-2">
                <span id="audioIcon">üîä</span>
                <span id="audioText">Audio</span>
            </button>
        </div>

        <!-- Stats -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
            <div class="stats shadow border border-base-content/10 hover:border-success/50 transition-colors">
                <div class="stat">
                    <div class="stat-figure text-success">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                        </svg>
                    </div>
                    <div class="stat-title text-xs">Equipos Activos</div>
                    <div class="stat-value text-3xl font-gaming text-success" id="totalTeams">{{ teams|length }}</div>
                    <div class="stat-desc text-xs opacity-60">Compitiendo</div>
                </div>
            </div>
            
            <div class="stats shadow border border-base-content/10 hover:border-warning/50 transition-colors">
                <div class="stat">
                    <div class="stat-figure text-warning">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 21v-4m0 0V5a2 2 0 012-2h6.5l1 1H21l-3 6 3 6h-8.5l-1-1H5a2 2 0 00-2 2zm9-13.5V9"></path>
                        </svg>
                    </div>
                    <div class="stat-title text-xs">Flags Capturadas</div>
                    <div class="stat-value text-3xl font-gaming text-warning" id="totalFlags">{{ recent_submissions|length }}</div>
                    <div class="stat-desc text-xs opacity-60">Total de resoluciones</div>
                </div>
            </div>
            
            <div class="stats shadow border border-base-content/10 hover:border-error/50 transition-colors">
                <div class="stat">
                    <div class="stat-figure text-error">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"></path>
                        </svg>
                    </div>
                    <div class="stat-title text-xs">First Bloods</div>
                    <div class="stat-value text-3xl font-gaming text-error" id="totalFirstBloods">{{ first_bloods|length }}</div>
                    <div class="stat-desc text-xs opacity-60">Primeras resoluciones</div>
                </div>
            </div>

            <div class="stats shadow border border-base-content/10 hover:border-info/50 transition-colors">
                <div class="stat">
                    <div class="stat-figure text-info">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                    </div>
                    <div class="stat-title text-xs">Actividad</div>
                    <div class="stat-value text-3xl font-gaming text-info" id="lastActivity">--</div>
                    <div class="stat-desc text-xs opacity-60">√öltima flag</div>
                </div>
            </div>
        </div>

        <!-- Timeline Chart -->
        <div class="card bg-base-300 border border-base-content/10 mb-6">
            <div class="card-body">
                <h2 class="text-2xl font-gaming font-bold mb-4 flex items-center gap-2">
                    <span>üìä</span>
                    <span>Timeline de Progreso</span>
                </h2>
                <div class="h-64">
                    <canvas id="timelineChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
            <!-- Scoreboard Table -->
            <div class="xl:col-span-2">
                <div class="card bg-base-300 border border-base-content/10">
                    <div class="card-body">
                        <h2 class="card-title text-2xl font-gaming mb-4 flex items-center gap-2">
                            <span>üèÜ</span>
                            <span>Rankings</span>
                        </h2>
                        
                        <div class="overflow-x-auto">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th class="font-gaming">#</th>
                                        <th class="font-gaming">Equipo</th>
                                        <th class="font-gaming">Puntos</th>
                                        <th class="font-gaming">Flags</th>
                                    </tr>
                                </thead>
                                <tbody id="rankingsTable">
                                    {% for team in teams %}
                                    <tr class="team-row hover transition-all" data-team-id="{{ team.id }}">
                                        <td class="font-mono font-bold text-lg">
                                            {% if forloop.counter == 1 %}
                                                <span class="text-yellow-400">ü•á</span>
                                            {% elif forloop.counter == 2 %}
                                                <span class="text-gray-400">ü•à</span>
                                            {% elif forloop.counter == 3 %}
                                                <span class="text-orange-400">ü•â</span>
                                            {% else %}
                                                {{ forloop.counter }}
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="flex items-center gap-3">
                                                <div class="w-4 h-4 rounded-full shadow-lg" 
                                                     style="background-color: {{ team.color }}; box-shadow: 0 0 10px {{ team.color }}80;"></div>
                                                <span class="font-gaming font-semibold">{{ team.name }}</span>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="badge badge-success font-mono font-bold">{{ team.total_score }} pts</span>
                                        </td>
                                        <td class="opacity-60">
                                            <span class="badge badge-ghost badge-sm">{{ team.solved_count }} flags</span>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="space-y-6">
                <!-- First Bloods -->
                <div class="card bg-base-300 border border-base-content/10">
                    <div class="card-body">
                        <h3 class="card-title text-xl font-gaming mb-4">ü©∏ First Bloods</h3>
                        
                        <div class="space-y-2" id="firstBloodsList">
                            {% for fb in first_bloods|slice:":10" %}
                            <div class="p-3 bg-base-200 rounded-lg border border-error/20">
                                <div class="font-gaming font-semibold text-sm">{{ fb.challenge.title }}</div>
                                <div class="text-xs opacity-60 mt-1">
                                    <span style="color: {{ fb.team.color }}">{{ fb.team.name }}</span>
                                    <span class="badge badge-error badge-xs ml-2">+{{ fb.bonus_points }}</span>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="card bg-base-300 border border-base-content/10">
                    <div class="card-body">
                        <h3 class="card-title text-xl font-gaming mb-4">‚ö° Actividad Reciente</h3>
                        
                        <div class="space-y-2" id="recentActivity">
                            {% for sub in recent_submissions|slice:":10" %}
                            <div class="p-2 bg-base-200 rounded-lg text-xs">
                                <div class="font-gaming font-semibold" style="color: {{ sub.team.color }}">
                                    {{ sub.team.name }}
                                </div>
                                <div class="opacity-60 mt-1">
                                    {{ sub.challenge.title }} ‚Ä¢ {{ sub.submitted_at|timesince }} ago
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let timelineChart;
        let audioEnabled = false;
        let soundQueue = [];
        let isPlayingSound = false;
        
        // Audio files
        const soundFiles = {
            flag_solved: new Audio('{% static "sounds/flag_solved.mp3" %}'),
            first_blood: new Audio('{% static "sounds/first_blood.mp3" %}'),
            rank_up: new Audio('{% static "sounds/rank_up.mp3" %}'),
            rank_down: new Audio('{% static "sounds/rank_down.mp3" %}')
        };

        // Notification queue
        let notificationQueue = [];
        let isShowingNotification = false;

        // Initialize audio
        function initializeAudio() {
            Object.values(soundFiles).forEach(sound => {
                sound.volume = 0;
                sound.play().then(() => {
                    sound.pause();
                    sound.currentTime = 0;
                    sound.volume = 0.7;
                }).catch(e => console.log('Audio preload:', e));
            });
        }

        function enableAudio() {
            document.getElementById('audioEnableOverlay').style.display = 'none';
            audioEnabled = true;
            initializeAudio();
            updateAudioStatus();
        }

        function toggleAudio() {
            audioEnabled = !audioEnabled;
            updateAudioStatus();
        }

        function updateAudioStatus() {
            const icon = document.getElementById('audioIcon');
            icon.textContent = audioEnabled ? 'üîä' : 'üîá';
        }

        function playSound(soundType) {
            if (!audioEnabled || !soundFiles[soundType]) return;
            soundQueue.push(soundType);
            processSoundQueue();
        }

        function processSoundQueue() {
            if (isPlayingSound || soundQueue.length === 0) return;
            
            isPlayingSound = true;
            const soundType = soundQueue.shift();
            const sound = soundFiles[soundType];
            
            if (sound) {
                sound.currentTime = 0;
                sound.play().then(() => {
                    sound.onended = () => {
                        isPlayingSound = false;
                        setTimeout(() => processSoundQueue(), 100);
                    };
                }).catch(e => {
                    console.error('Error playing sound:', e);
                    isPlayingSound = false;
                    processSoundQueue();
                });
            } else {
                isPlayingSound = false;
                processSoundQueue();
            }
        }

        function queueNotification(text, color, icon, soundType) {
            notificationQueue.push({ text, color, icon, soundType });
            processNotificationQueue();
        }

        function processNotificationQueue() {
            if (isShowingNotification || notificationQueue.length === 0) return;
            
            isShowingNotification = true;
            const notification = notificationQueue.shift();
            showNotification(notification.text, notification.color, notification.icon, notification.soundType);
        }

        function showNotification(text, color, icon, soundType) {
            if (soundType) {
                playSound(soundType);
            }

            const overlay = document.createElement('div');
            overlay.className = 'notification-overlay';
            
            const htmlContent = `
                <div class="alert shadow-2xl" style="border-color: ${color}; border-width: 3px;">
                    <div class="text-center w-full">
                        <div class="notification-icon mb-3">${icon}</div>
                        <div class="text-2xl font-gaming font-bold" style="color: ${color}">
                            ${text}
                        </div>
                    </div>
                </div>
            `;
            
            overlay.innerHTML = htmlContent;
            document.body.appendChild(overlay);
            
            setTimeout(() => {
                overlay.remove();
                isShowingNotification = false;
                processNotificationQueue();
            }, 4000);
        }

        // Initialize timeline chart
        function initTimelineChart(timelineData) {
            const ctx = document.getElementById('timelineChart');
            if (!ctx) return;

            const teamColors = {};
            {% for team in teams %}
            teamColors['{{ team.name }}'] = '{{ team.color }}';
            {% endfor %}

            const teamData = {};
            timelineData.forEach(point => {
                if (!teamData[point.team]) {
                    teamData[point.team] = [];
                }
                teamData[point.team].push({
                    x: new Date(point.time),
                    y: point.score
                });
            });

            const datasets = Object.keys(teamData).map(teamName => ({
                label: teamName,
                data: teamData[teamName],
                borderColor: teamColors[teamName] || '#00FF41',
                backgroundColor: (teamColors[teamName] || '#00FF41') + '30',
                borderWidth: 4,
                tension: 0.4,
                pointRadius: 5,
                pointHoverRadius: 8,
                pointBackgroundColor: teamColors[teamName] || '#00FF41',
                pointBorderColor: '#1a1a2e',
                pointBorderWidth: 2,
                fill: false
            }));

            if (timelineChart) {
                timelineChart.destroy();
            }

            timelineChart = new Chart(ctx, {
                type: 'line',
                data: { datasets: datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                font: { family: 'Rajdhani', size: 16, weight: 'bold' },
                                color: '#a6adbb',
                                usePointStyle: true,
                                pointStyle: 'circle',
                                padding: 20,
                                boxWidth: 15,
                                boxHeight: 15
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.9)',
                            titleFont: { family: 'Rajdhani', size: 16, weight: 'bold' },
                            bodyFont: { family: 'Space Mono', size: 14 },
                            padding: 15,
                            displayColors: true,
                            borderColor: '#00FF41',
                            borderWidth: 2
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'minute',
                                displayFormats: { 
                                    minute: 'HH:mm', 
                                    hour: 'HH:mm' 
                                },
                                tooltipFormat: 'dd/MM HH:mm'
                            },
                            grid: { 
                                color: 'rgba(166,173,187,0.15)',
                                lineWidth: 1
                            },
                            ticks: {
                                font: { family: 'Space Mono', size: 12 },
                                color: '#a6adbb'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: { 
                                color: 'rgba(166,173,187,0.15)',
                                lineWidth: 1
                            },
                            ticks: {
                                font: { family: 'Space Mono', size: 12 },
                                color: '#a6adbb'
                            },
                            title: {
                                display: true,
                                text: 'Puntos',
                                font: { family: 'Rajdhani', size: 16, weight: 'bold' },
                                color: '#00FF41'
                            }
                        }
                    }
                }
            });
        }

        // Update clock
        function updateClock() {
            const now = new Date();
            document.getElementById('currentTime').textContent = now.toLocaleTimeString('es-CL');
        }

        // WebSocket connection
        const ws = new WebSocket('ws://' + window.location.host + '/ws/scoreboard/');
        
        ws.onmessage = function(e) {
            const data = JSON.parse(e.data);
            
            // Manejar eventos de prueba directos
            if (data.type === 'flag_solved' && data.message) {
                queueNotification(data.message, '#4ade80', 'üö©', 'flag_solved');
                return;
            }
            
            if (data.type === 'first_blood' && data.message) {
                queueNotification(data.message, '#f59e0b', 'ü©∏', 'first_blood');
                return;
            }
            
            if (data.type === 'achievement_unlocked' && data.message) {
                queueNotification(data.message, '#a855f7', 'üèÜ', 'rank_up');
                return;
            }
            
            if (data.type === 'rank_change' && data.message) {
                const icon = data.new_rank < data.old_rank ? 'üìà' : 'üìâ';
                const sound = data.new_rank < data.old_rank ? 'rank_up' : 'rank_down';
                queueNotification(data.message, '#3b82f6', icon, sound);
                return;
            }
            
            if (data.type === 'notification' && data.message) {
                const colors = {
                    'info': '#3b82f6',
                    'success': '#22c55e',
                    'warning': '#f59e0b',
                    'error': '#ef4444'
                };
                const icons = {
                    'info': '‚ÑπÔ∏è',
                    'success': '‚úÖ',
                    'warning': '‚ö†Ô∏è',
                    'error': '‚ùå'
                };
                const notifType = data.notification_type || 'info';
                const color = colors[notifType] || colors.info;
                const icon = icons[notifType] || icons.info;
                queueNotification(data.message, color, icon, 'flag_solved');
                return;
            }
            
            if (data.type === 'custom_announcement') {
                const colors = {
                    'info': '#3b82f6',
                    'success': '#22c55e',
                    'warning': '#f59e0b',
                    'error': '#ef4444'
                };
                const icons = {
                    'info': '‚ÑπÔ∏è',
                    'success': '‚úÖ',
                    'warning': '‚ö†Ô∏è',
                    'error': '‚ùå'
                };
                const color = colors[data.notification_type] || colors.info;
                const icon = icons[data.notification_type] || icons.info;
                queueNotification(`${data.title}: ${data.message}`, color, icon, 'flag_solved');
                return;
            }
            
            if (data.type === 'display_data_update') {
                if (data.event_type === 'flag_solved') {
                    const eventData = data.event_data;
                    
                    if (eventData.is_first_blood) {
                        queueNotification(
                            `${eventData.team} consigui√≥ FIRST BLOOD en ${eventData.challenge}!`,
                            eventData.color,
                            'ü©∏',
                            'first_blood'
                        );
                    } else {
                        queueNotification(
                            `${eventData.team} resolvi√≥ ${eventData.challenge}!`,
                            eventData.color,
                            'üéØ',
                            'flag_solved'
                        );
                    }
                    
                    // Consolidar logros en una sola notificaci√≥n
                    if (eventData.new_achievements && eventData.new_achievements.length > 0) {
                        const achievements = eventData.new_achievements;
                        
                        if (achievements.length === 1) {
                            // Solo un logro, mostrar normal
                            const achievement = achievements[0];
                            const achievementText = achievement.type === 'individual' 
                                ? `${achievement.user} (${achievement.team}) desbloque√≥: ${achievement.name}!`
                                : `${achievement.team} desbloque√≥: ${achievement.name}!`;
                            
                            queueNotification(
                                achievementText,
                                achievement.color,
                                achievement.icon,
                                'rank_up'
                            );
                        } else {
                            // M√∫ltiples logros, consolidar
                            const teamName = achievements[0].team;
                            const icons = achievements.map(a => a.icon).join(' ');
                            const names = achievements.map(a => a.name).join(', ');
                            const achievementText = `${teamName} desbloque√≥ ${achievements.length} logros: ${names}!`;
                            
                            queueNotification(
                                achievementText,
                                achievements[0].color,
                                icons,
                                'rank_up'
                            );
                        }
                    }
                }
                
                updateRankings(data.teams);
                updateFirstBloods(data.first_bloods);
                updateRecentActivity(data.recent_submissions);
                updateTimelineChart(data.timeline);
                updateStats(data);
            }
        };

        function updateRankings(teams) {
            const tbody = document.getElementById('rankingsTable');
            if (!tbody) return;
            
            tbody.innerHTML = teams.map((team, idx) => {
                let rankDisplay;
                if (idx === 0) {
                    rankDisplay = '<span class="text-yellow-400">ü•á</span>';
                } else if (idx === 1) {
                    rankDisplay = '<span class="text-gray-400">ü•à</span>';
                } else if (idx === 2) {
                    rankDisplay = '<span class="text-orange-400">ü•â</span>';
                } else {
                    rankDisplay = idx + 1;
                }
                
                return `
                    <tr class="team-row hover transition-all" data-team-id="${team.id}">
                        <td class="font-mono font-bold text-lg">
                            ${rankDisplay}
                        </td>
                        <td>
                            <div class="flex items-center gap-3">
                                <div class="w-4 h-4 rounded-full shadow-lg" 
                                     style="background-color: ${team.color}; box-shadow: 0 0 10px ${team.color}80;"></div>
                                <span class="font-gaming font-semibold">${team.name}</span>
                            </div>
                        </td>
                        <td>
                            <span class="badge badge-success font-mono font-bold">${team.score} pts</span>
                        </td>
                        <td class="opacity-60">
                            <span class="badge badge-ghost badge-sm">${team.solved} flags</span>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function updateFirstBloods(firstBloods) {
            const container = document.getElementById('firstBloodsList');
            if (!container) return;
            
            container.innerHTML = firstBloods.slice(0, 10).map(fb => `
                <div class="p-3 bg-base-200 rounded-lg border border-error/20">
                    <div class="font-gaming font-semibold text-sm">${fb.challenge}</div>
                    <div class="text-xs opacity-60 mt-1">
                        <span style="color: ${fb.team_color}">${fb.team}</span>
                        <span class="badge badge-error badge-xs ml-2">+${fb.bonus_points}</span>
                    </div>
                </div>
            `).join('');
        }

        function updateRecentActivity(submissions) {
            const container = document.getElementById('recentActivity');
            if (!container) return;
            
            container.innerHTML = submissions.slice(0, 10).map(sub => `
                <div class="p-2 bg-base-200 rounded-lg text-xs">
                    <div class="font-gaming font-semibold" style="color: ${sub.team_color}">
                        ${sub.team}
                    </div>
                    <div class="opacity-60 mt-1">
                        ${sub.challenge} ‚Ä¢ ${sub.time_ago}
                    </div>
                </div>
            `).join('');
            
            if (submissions.length > 0) {
                document.getElementById('lastActivity').textContent = submissions[0].time_ago;
            }
        }

        function updateTimelineChart(timelineData) {
            if (timelineChart && timelineData) {
                initTimelineChart(timelineData);
            }
        }

        function updateStats(data) {
            document.getElementById('totalTeams').textContent = data.teams.length;
            document.getElementById('totalFlags').textContent = data.recent_submissions.length;
            document.getElementById('totalFirstBloods').textContent = data.first_bloods.length;
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', function() {
            const timelineData = {{ timeline_data|safe }};
            initTimelineChart(timelineData);
            updateClock();
            setInterval(updateClock, 1000);
            
            // Set initial audio status (muted by default)
            updateAudioStatus();
            
            // Initialize last activity
            {% if recent_submissions %}
                {% with recent_submissions|first as latest %}
                    document.getElementById('lastActivity').textContent = '{{ latest.submitted_at|timesince }}';
                {% endwith %}
            {% else %}
                document.getElementById('lastActivity').textContent = 'Sin actividad';
            {% endif %}
            
            // Show audio overlay on first click
            let hasInteracted = false;
            document.addEventListener('click', function() {
                if (!hasInteracted) {
                    hasInteracted = true;
                    document.getElementById('audioEnableOverlay').style.display = 'flex';
                }
            }, { once: true });
        });

        // Anti-DevTools Protection (Display p√∫blico)
        (function() {
            // Detectar apertura de DevTools
            let devtoolsOpen = false;
            const threshold = 160;
            
            function detectDevTools() {
                const widthThreshold = window.outerWidth - window.innerWidth > threshold;
                const heightThreshold = window.outerHeight - window.innerHeight > threshold;
                
                if ((widthThreshold || heightThreshold) && !devtoolsOpen) {
                    devtoolsOpen = true;
                    handleDevToolsOpen();
                }
            }
            
            function handleDevToolsOpen() {
                document.body.innerHTML = `
                    <div class="min-h-screen flex items-center justify-center bg-base-100">
                        <div class="card w-96 bg-base-300 shadow-xl border-4 border-error">
                            <div class="card-body text-center">
                                <h2 class="text-6xl mb-4">üîí</h2>
                                <h3 class="card-title text-2xl font-gaming text-error justify-center">Acceso Restringido</h3>
                                <p class="text-lg mb-4">Esta pantalla de visualizaci√≥n est√° protegida.</p>
                                <p class="text-sm opacity-60">Cierra las herramientas de desarrollo para continuar.</p>
                                <div class="card-actions justify-center mt-4">
                                    <button onclick="location.reload()" class="btn btn-primary btn-sm">Recargar P√°gina</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Deshabilitar click derecho
            document.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                return false;
            });
            
            // Deshabilitar atajos de teclado
            document.addEventListener('keydown', function(e) {
                // F12, Ctrl+Shift+I/J/C, Ctrl+U, Ctrl+S
                if (e.keyCode === 123 || 
                    (e.ctrlKey && e.shiftKey && [73, 74, 67].includes(e.keyCode)) ||
                    (e.ctrlKey && [85, 83].includes(e.keyCode))) {
                    e.preventDefault();
                    return false;
                }
            });
            
            // Detectar peri√≥dicamente
            setInterval(detectDevTools, 1000);
            
            // Detecci√≥n inicial
            detectDevTools();
        })();
    </script>
</body>
</html>
